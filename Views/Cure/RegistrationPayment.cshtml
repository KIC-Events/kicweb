@using KiCData.Models.WebModels
@using KiCData.Models.WebModels.PaymentModels
@using System.Text.Json

@model CureCardFormModel

<form class="container" method="post" asp-action="RegistrationPayment">
  <div class="cure-payment">
    <div class="cure-payment__main">
      <section class="page-section">
        <h1 class="h2">Review your order</h1>

        <div class="content body-text">
          <p>Review your selections below. Click the pencil icon next to a ticket to edit it.</p>

          @for (int i = 0; i < Model.Items.Count; i++)
          {
              var item = Model.Items[i];

              <div class="cure-payment__ticket-box">
                <strong>TICKET @(i + 1): @item.TicketType.ToUpper() TICKET</strong><br />

                <p>First Name: @item.FirstName</p>
                <p>Last Name: @item.LastName</p>
                <p>DoB: @(item.DateOfBirth?.ToString("MM/dd/yyyy") ?? "N/A")</p>
                <p>Email: @item.Email</p>
                <p>Phone: @item.PhoneNumber</p>
                <br />
                <p>Badge Name: @item.BadgeName</p>

                @if (!string.IsNullOrEmpty(item.Pronouns))
                {
                    <p>Pronouns: @item.Pronouns</p>
                }

                <p>Room Type: @item.RoomType</p>
              </div>
          }
        </div>          
      </section>

      <section class="page-section">
        <h2>
          Contact information
        </h2>

        <div class="content body-text">
          <p>
            Please provide contact info for the person completing the ticket purchase. We’ll use this information to contact you if there’s an issue with your ticket order.
          </p>
          <div class="cure-payment__field-row">
            @* First name *@
            <div class="field field--inline">
              <input asp-for="BillingContact.GivenName" />
              <label asp-for="BillingContact.GivenName"></label>
            </div>

            @* Last name *@
            <div class="field field--inline">
              <input asp-for="BillingContact.FamilyName" />
              <label asp-for="BillingContact.FamilyName"></label>
            </div>
          </div>

          <div class="cure-payment__field-row">
            @* Email *@
            <div class="field field--inline" style="max-width: calc(var(--field-row-width) / 2 + 4rem)">
              <input asp-for="BillingContact.EmailAddress" type="email" />
              <label asp-for="BillingContact.EmailAddress"></label>
            </div>

            @* Phone number *@
            <div class="field field--inline" style="max-width: calc(var(--field-row-width) / 2 - 4rem)">
              <input asp-for="BillingContact.PhoneNumber" type="tel" placeholder="@Html.PromptFor(m => m.BillingContact.PhoneNumber)" />
              <label asp-for="BillingContact.PhoneNumber"></label>
            </div>
          </div>
        </div>        
      </section>

      <section class="page-section">
        <h2>Billing Information</h2>

        <div class="content">

          <div class="cure-payment__field-row">
            @* Address Line 1 *@
            <div class="field field--inline">
              <input asp-for="BillingContact.AddressLine1" />
              <label asp-for="BillingContact.AddressLine1"></label>
            </div>
          </div>

          <div class="cure-payment__field-row">
            @* Address Line 2 *@
            <div class="field field--inline">
              <input asp-for="BillingContact.AddressLine2" />
              <label asp-for="BillingContact.AddressLine2"></label>
            </div>
          </div>

          <div class="cure-payment__field-row">
            @* City *@
            <div class="field field--inline" style="max-width: calc(var(--field-row-width) / 3 + 1.5rem)">
              <input asp-for="BillingContact.City" />
              <label asp-for="BillingContact.City"></label>
            </div>

            @* State *@
            <div class="field field--inline" style="max-width: calc(var(--field-row-width) / 3 - 3rem)">
              <select required asp-for="BillingContact.State">
                <option value=""></option>
                <option value="AL">AL</option>
                <option value="AK">AK</option>
                <option value="AZ">AZ</option>
                <option value="AR">AR</option>
                <option value="CA">CA</option>
                <option value="CO">CO</option>
                <option value="CT">CT</option>
                <option value="DE">DE</option>
                <option value="FL">FL</option>
                <option value="GA">GA</option>
                <option value="HI">HI</option>
                <option value="ID">ID</option>
                <option value="IL">IL</option>
                <option value="IN">IN</option>
                <option value="IA">IA</option>
                <option value="KS">KS</option>
                <option value="KY">KY</option>
                <option value="LA">LA</option>
                <option value="ME">ME</option>
                <option value="MD">MD</option>
                <option value="MA">MA</option>
                <option value="MI">MI</option>
                <option value="MN">MN</option>
                <option value="MS">MS</option>
                <option value="MO">MO</option>
                <option value="MT">MT</option>
                <option value="NE">NE</option>
                <option value="NV">NV</option>
                <option value="NH">NH</option>
                <option value="NJ">NJ</option>
                <option value="NM">NM</option>
                <option value="NY">NY</option>
                <option value="NC">NC</option>
                <option value="ND">ND</option>
                <option value="OH">OH</option>
                <option value="OK">OK</option>
                <option value="OR">OR</option>
                <option value="PA">PA</option>
                <option value="RI">RI</option>
                <option value="SC">SC</option>
                <option value="SD">SD</option>
                <option value="TN">TN</option>
                <option value="TX">TX</option>
                <option value="UT">UT</option>
                <option value="VT">VT</option>
                <option value="VA">VA</option>
                <option value="WA">WA</option>
                <option value="WV">WV</option>
                <option value="WI">WI</option>
                <option value="WY">WY</option>
              </select>
              <label asp-for="BillingContact.State"></label>
            </div>

            @* Postal Code *@
            <div class="field field--inline" style="max-width: calc(var(--field-row-width) / 3 + 1.5rem)">
              <input asp-for="BillingContact.PostalCode" />
              <label asp-for="BillingContact.PostalCode"></label>
            </div>
          </div>
        </div>

        <!-- Card fields and form -->
        <input type="hidden" asp-for="CardToken" />
        <div id="card-container"></div>

        <button type="button" id="submit-button" class="button">
          Checkout
        </button>
      </section>
    </div>

    <div class="cure-payment__summary">
      <div class="order-summary">
        <h3>Your Order</h3>
        <p>Test 123</p>
      </div>
    </div>
  </div>
</form>

@if (Environment.GetEnvironmentVariable("IS_LOCAL_DEV") == "true")
{
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
}
else 
{
  <script src="https://web.squarecdn.com/v1/square.js"></script>
}

<style>

</style>

<script>
  (async () => {
    const payments = Square.payments('@ViewBag.AppId', '@ViewBag.LocationId');
    const card = await payments.card({
      style: {
        input: {
          fontFamily: 'verdana, sans-serif',
          fontSize: '14px',
        },
        'input::placeholder': {
          color: '#505050',
        }
      }
    });
    await card.attach('#card-container');

    const submitButton = document.getElementById('submit-button');
    const form = document.querySelector('form');

    // This request submit runs our validation.
    // If the form is valid, we proceed to tokenize the card and actually submit to the server.
    submitButton.addEventListener('click', async () => {
      form.requestSubmit();
    });

    // Handle the form submission
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      // Tokenize the card details
      const result = await card.tokenize();
      if (result.status === 'OK') {
        // If tokenization was successful, add the token to a hidden input and submit the form
        const tokenInput = document.getElementById('CardToken');
        tokenInput.value = result.token;
        form.submit();
      } else {
        // Handle errors.
        let errorMessage = 'Card payment failed: ';
        if (result.errors) {
          errorMessage += result.errors.map(e => e.message).join(', ');
        }
        alert(errorMessage);
      }
    });
  })();
</script>